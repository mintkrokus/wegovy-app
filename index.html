<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml' xmlns:b='http://www.google.com/2005/gml/b' xmlns:data='http://www.google.com/2005/gml/data' xmlns:expr='http://www.google.com/2005/gml/expr'>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Wegovy ç´€éŒ„</title>
    
    <!-- iOS PWA å°ˆç”¨è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Wegovyç´€éŒ„" />
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/180/syringe.png" />

    <!-- å¼•å…¥ React èˆ‡ Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- è¨­å®š Tailwind è‡ªå®šç¾©é¡è‰² -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9fb',
                            100: '#e0f3f7',
                            200: '#c2e7f0',
                            300: '#a3dae9',
                            400: '#85cee2',
                            500: '#68C5DB', // ä¸»è‰²
                            600: '#448FA3', // æ·±è‰² (ICON)
                            700: '#367282',
                        }
                    }
                }
            }
        }
    </script>
    
    <b:skin><![CDATA[
        body { background-color: #f8fafc; margin: 0; padding: 0; }
        .navbar { display: none !important; }
        #navbar-iframe { display: none !important; height: 0 !important; visibility: hidden !important; }
    ]]></b:skin>

    <style>
        * { -webkit-tap-highlight-color: transparent; user-select: none; }
        input, textarea { user-select: text; }
        body { background-color: #f0f9fb; overscroll-behavior-y: none; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-area-inset-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
    <b:section id='main' showaddelement='no'>
        <b:widget id='HTML1' locked='true' title='' type='HTML' version='2'>
            <b:widget-settings>
                <b:widget-setting name='content'></b:widget-setting>
            </b:widget-settings>
            <b:includable id='main'>
                <!-- React æ›è¼‰é» -->
            </b:includable>
        </b:widget>
    </b:section>

    <div id="root"></div>

    <script type="text/babel">
    //<![CDATA[
        const { useState, useEffect, useMemo } = React;

        // --- åœ–ç¤ºå®šç¾© ---
        const IconBase = ({ size = 24, color = "currentColor", children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                {children}
            </svg>
        );

        const Plus = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const TrendingDown = (props) => <IconBase {...props}><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></IconBase>;
        const Syringe = (props) => <IconBase {...props}><path d="m18 2 4 4"/><path d="m17 7 3-3"/><path d="M19 9 8.7 19.3c-1 1-2.5 1-3.4 0l-.6-.6c-1-1-1-2.5 0-3.4L15 5"/><path d="m9 11 4 4"/><path d="m5 19-3 3"/><path d="m14 4 6 6"/></IconBase>;
        const Calendar = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>;
        const Scale = (props) => <IconBase {...props}><rect x="4" y="4" width="16" height="16" rx="2" /><path d="M16 8H8" /><path d="M12 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" /></IconBase>;
        const History = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></IconBase>;
        const Activity = (props) => <IconBase {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const Edit2 = (props) => <IconBase {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconBase>;
        const RefreshCw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>;
        const User = (props) => <IconBase {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const Target = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconBase>;
        const Stethoscope = (props) => <IconBase {...props}><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/><path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/><circle cx="20" cy="10" r="2"/></IconBase>;
        const AlertCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>;
        const ChevronRight = (props) => <IconBase {...props}><polyline points="9 18 15 12 9 6" /></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const FileText = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconBase>;

        // --- APP LOGO (ç´”é‡ç­’) ---
        const AppLogo = ({ size = 32, color = "white" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" xmlns="http://www.w3.org/2000/svg">
                <path d="m18 2 4 4"/>
                <path d="m17 7 3-3"/>
                <path d="M19 9 8.7 19.3c-1 1-2.5 1-3.4 0l-.6-.6c-1-1-1-2.5 0-3.4L15 5"/>
                <path d="m9 11 4 4"/>
                <path d="m5 19-3 3"/>
                <path d="m14 4 6 6"/>
            </svg>
        );

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-2xl shadow-sm border border-primary-200 ${className}`}>
                {children}
            </div>
        );

        // åŠ‘é‡æ›ç®—é‚è¼¯ (mg -> æ ¼æ•¸)
        const mgToClicks = (mg) => {
            const val = parseFloat(mg);
            if (isNaN(val) || val === 0) return 0;
            if (Math.abs(val - 0.25) < 0.01) return 19;
            if (Math.abs(val - 0.5) < 0.01) return 37;
            if (Math.abs(val - 0.75) < 0.01) return 56;
            if (Math.abs(val - 1.0) < 0.01) return 75;
            return Math.round(val * 75);
        };
        
        // æ ¼æ•¸ -> mg (åå‘æ›ç®—)
        const clicksToMg = (clicks) => {
            const c = parseInt(clicks);
            if (isNaN(c) || c === 0) return 0;
            if (c === 19) return 0.25;
            if (c === 37) return 0.5;
            if (c === 56) return 0.75;
            if (c === 75) return 1.0;
            return parseFloat((c / 75).toFixed(2));
        };

        const DOSAGE_SUGGESTIONS = [
            { value: 0.25, label: '0.25' },
            { value: 0.5, label: '0.5' },
            { value: 0.75, label: '0.75' },
            { value: 1.0, label: '1.0' },
            { value: 1.7, label: '1.7' },
            { value: 2.4, label: '2.4' },
        ];

        const COMMON_SYMPTOMS = [
            'ç„¡å‰¯ä½œç”¨', 'ğŸ¤¢ å™å¿ƒ', 'ğŸ¤® å˜”å', 'ğŸš½ ä¾¿ç§˜', 'ğŸ’© è…¹ç€‰', 'ğŸ¥´ é ­æšˆ', 'ğŸ˜´ ç–²å€¦', 'ğŸ¤ é£Ÿæ…¾ä¸æŒ¯', 'ğŸ¤• é ­ç—›', 'ğŸ”¥ èƒƒé£Ÿé“é€†æµ'
        ];

        function App() {
            // --- ç‹€æ…‹ç®¡ç† ---
            const [records, setRecords] = useState(() => {
                const savedRecords = localStorage.getItem('saxenda_records');
                // é€™è£¡æ”¹ç‚ºç©ºé™£åˆ—ï¼Œä¸ä½¿ç”¨ä»»ä½•é è¨­æ¸¬è©¦è³‡æ–™
                return savedRecords ? JSON.parse(savedRecords) : [];
            });

            const [userProfile, setUserProfile] = useState(() => {
                const saved = localStorage.getItem('saxenda_profile');
                const defaults = { 
                    height: '', 
                    targetWeight: '', 
                    penTotal: 4.0, 
                    currentPenStartDate: new Date().toISOString().split('T')[0],
                    penCount: 1,
                    isInitialized: false
                };
                return saved ? { ...defaults, ...JSON.parse(saved) } : defaults;
            });

            const [activeTab, setActiveTab] = useState('dashboard');
            
            useEffect(() => {
                if (!userProfile.isInitialized) {
                    setActiveTab('onboarding');
                }
            }, [userProfile.isInitialized]);

            const [historyType, setHistoryType] = useState('injection');
            const [showNotification, setShowNotification] = useState(false);
            const [showInsufficientModal, setShowInsufficientModal] = useState(false);
            const [showNewPenModal, setShowNewPenModal] = useState(false);
            const [finishedPenDate, setFinishedPenDate] = useState('');
            const [editingId, setEditingId] = useState(null);
            const [recordType, setRecordType] = useState('weight');

            const [formDate, setFormDate] = useState(new Date().toISOString().split('T')[0]);
            const [formWeight, setFormWeight] = useState('');
            const [formDosage, setFormDosage] = useState('0.25');
            const [formNote, setFormNote] = useState(''); // Keep state variable to prevent ReferenceError, but not used in UI
            const [formSite, setFormSite] = useState('è…¹éƒ¨');
            const [formHeight, setFormHeight] = useState('');
            const [formSymptoms, setFormSymptoms] = useState([]);
            
            const [dosageUnit, setDosageUnit] = useState('mg');
            const [formClicks, setFormClicks] = useState('19');

            const [setupHeight, setSetupHeight] = useState('');
            const [setupTarget, setSetupTarget] = useState('');
            const [setupPenTotal, setSetupPenTotal] = useState('4.0');
            const [setupStartDate, setSetupStartDate] = useState(new Date().toISOString().split('T')[0]);

            useEffect(() => {
                if (!userProfile.height) setFormHeight('');
                else setFormHeight(userProfile.height);
            }, [userProfile.height]);

            useEffect(() => { localStorage.setItem('saxenda_records', JSON.stringify(records)); }, [records]);
            useEffect(() => { localStorage.setItem('saxenda_profile', JSON.stringify(userProfile)); }, [userProfile]);

            useEffect(() => {
                if (dosageUnit === 'mg') {
                    setFormClicks(mgToClicks(formDosage).toString());
                }
            }, [formDosage, dosageUnit]);

            useEffect(() => {
                if (dosageUnit === 'clicks') {
                    setFormDosage(clicksToMg(formClicks).toString());
                }
            }, [formClicks, dosageUnit]);

            const formatDateWithDay = (dateStr) => {
                if (!dateStr) return '';
                const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                const [y, m, d] = dateStr.split('-').map(Number);
                const date = new Date(y, m - 1, d);
                const dayName = days[date.getDay()];
                return `${y}/${m.toString().padStart(2, '0')}/${d.toString().padStart(2, '0')}(${dayName})`;
            };

            const sortedRecords = useMemo(() => {
                return [...records].sort((a, b) => new Date(b.date) - new Date(a.date));
            }, [records]);

            const displayedHistory = useMemo(() => {
                return sortedRecords.filter(r => {
                    if (historyType === 'injection') return r.dosage > 0;
                    return r.weight !== null && r.weight !== '' && !isNaN(r.weight);
                });
            }, [sortedRecords, historyType]);

            const stats = useMemo(() => {
                const validWeightRecords = records.filter(r => r.weight !== null && r.weight !== '' && !isNaN(r.weight));
                const latestInjection = [...records].sort((a, b) => new Date(a.date) - new Date(b.date)).reverse().find(r => r.dosage > 0);
                
                const currentPenRecords = records.filter(r => {
                    if (r.penCount) return r.penCount === userProfile.penCount;
                    return r.date >= userProfile.currentPenStartDate;
                });

                const totalUsed = currentPenRecords.reduce((acc, curr) => acc + (curr.dosage || 0), 0);
                const remaining = Math.max(0, userProfile.penTotal - totalUsed);
                const remainingClicks = mgToClicks(remaining);
                
                const lastDose = latestInjection ? latestInjection.dosage : 0;
                const lastInjectionDate = latestInjection ? latestInjection.date : null;

                let nextInjectionDate = null;
                let daysUntilNext = null;
                if (lastInjectionDate) {
                    const nextDateObj = new Date(lastInjectionDate);
                    nextDateObj.setDate(nextDateObj.getDate() + 7);
                    nextInjectionDate = nextDateObj.toISOString().split('T')[0];
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    nextDateObj.setHours(0,0,0,0);
                    daysUntilNext = Math.ceil((nextDateObj - today) / (1000 * 60 * 60 * 24));
                }

                const calculationBaseDose = lastDose > 0 ? lastDose : 0.25;
                const dosesLeft = Math.floor(remaining / calculationBaseDose);
                const progressPercent = Math.min(100, Math.max(0, (remaining / userProfile.penTotal) * 100));

                let weightStats = { current: 0, start: 0, loss: 0, bmi: 0 };
                if (validWeightRecords.length > 0) {
                    const timeSortedWeights = [...validWeightRecords].sort((a, b) => new Date(a.date) - new Date(b.date));
                    const latest = timeSortedWeights[timeSortedWeights.length - 1];
                    const first = timeSortedWeights[0];
                    const current = parseFloat(latest.weight);
                    const start = parseFloat(first.weight);
                    const h = userProfile.height / 100;
                    weightStats = {
                        current: current.toFixed(1),
                        start: start.toFixed(1),
                        loss: (start - current).toFixed(1),
                        bmi: (current / (h * h)).toFixed(1)
                    };
                }

                return { 
                    ...weightStats, 
                    lastDose, 
                    lastInjectionDate, 
                    nextInjectionDate, 
                    daysUntilNext, 
                    totalUsed, 
                    remaining: remaining.toFixed(2), 
                    remainingClicks,
                    dosesLeft, 
                    progressPercent,
                    calculationBaseDose
                };
            }, [records, userProfile]);

            // --- Handler Functions ---

            const handleCompleteSetup = (e) => {
                e.preventDefault();
                if (!setupHeight || !setupTarget || !setupPenTotal || !setupStartDate) return;
                
                setUserProfile({
                    ...userProfile,
                    height: parseFloat(setupHeight),
                    targetWeight: parseFloat(setupTarget),
                    penTotal: parseFloat(setupPenTotal),
                    isInitialized: true,
                    currentPenStartDate: setupStartDate
                });
                setActiveTab('dashboard');
            };

            const handleAddRecord = (e) => {
                e.preventDefault();
                if (!formDate) return;

                if (recordType === 'injection') {
                    const dose = parseFloat(formDosage);
                    const currentRemaining = parseFloat(stats.remaining);
                    
                    if (dose > currentRemaining) {
                        setShowInsufficientModal(true);
                        return; 
                    }
                }

                if (recordType === 'injection' && formDate < userProfile.currentPenStartDate) {
                    const confirmBackfill = window.confirm(
                        `âš ï¸ æ³¨æ„ï¼šæ‚¨è¼¸å…¥çš„æ—¥æœŸ (${formatDateWithDay(formDate)}) æ—©æ–¼ç›®å‰è—¥ç­†çš„å•Ÿç”¨æ—¥æœŸ (${formatDateWithDay(userProfile.currentPenStartDate)})ã€‚\n\nè«‹å•é€™ç­†ç´€éŒ„æ˜¯å±¬æ–¼ã€Œç›®å‰é€™æ”¯æ–°ç­†ã€å—ï¼Ÿ\n\nâ— æŒ‰ [ç¢ºå®š]ï¼šæ˜¯ï¼Œé€™æ˜¯æ–°ç­†çš„ç´€éŒ„ (ç³»çµ±å°‡æŠŠå•Ÿç”¨æ—¥æœŸå¾€å‰ä¿®æ­£)\nâ— æŒ‰ [å–æ¶ˆ]ï¼šå¦ï¼Œé€™æ˜¯ä¸Šä¸€æ”¯ç­†çš„è£œç™» (ä¸æ‰£é™¤ç›®å‰åº«å­˜)`
                    );
                    
                    if (confirmBackfill) {
                        setUserProfile(prev => ({
                            ...prev,
                            currentPenStartDate: formDate
                        }));
                    }
                }
                
                saveRecord();
            };

            const saveRecord = () => {
                const isInjection = recordType === 'injection';
                const dose = isInjection ? parseFloat(formDosage) : 0;
                
                let willBeEmpty = false;
                if (isInjection) {
                    const currentRemaining = parseFloat(stats.remaining);
                    if (currentRemaining - dose <= 0.01) { 
                        willBeEmpty = true;
                    }
                }

                const newRecord = {
                    id: editingId || Date.now(),
                    date: formDate,
                    weight: recordType === 'weight' ? (formWeight ? parseFloat(formWeight) : null) : null,
                    dosage: dose,
                    site: recordType === 'injection' ? formSite : '',
                    symptoms: recordType === 'injection' ? formSymptoms : [],
                    penCount: recordType === 'injection' ? userProfile.penCount : null,
                    note: formNote // Note kept for data integrity
                };

                if (editingId) setRecords(prev => prev.map(r => r.id === editingId ? newRecord : r));
                else setRecords(prev => [...prev, newRecord]);

                setFormDate(new Date().toISOString().split('T')[0]);
                setFormWeight('');
                setFormNote('');
                setFormSymptoms([]);
                setShowNotification(true);
                setTimeout(() => setShowNotification(false), 3000);
                setActiveTab('dashboard');
                setShowInsufficientModal(false);

                if (willBeEmpty && !editingId) {
                    setFinishedPenDate(formDate); 
                    setTimeout(() => setShowNewPenModal(true), 500); 
                }
            };

            const handleUseRemaining = () => {
                const remaining = stats.remaining;
                setFormDosage(remaining);
                setFormClicks(mgToClicks(remaining).toString());
                setShowInsufficientModal(false);
            };

            const handleConfirmNewPen = () => {
                const nextStartDate = finishedPenDate;

                setUserProfile(prev => ({ 
                    ...prev, 
                    currentPenStartDate: nextStartDate,
                    penCount: (prev.penCount || 1) + 1 
                }));
                setShowNewPenModal(false);
                alert(`å·²å•Ÿç”¨ç¬¬ ${userProfile.penCount + 1} æ”¯ç­†ï¼\n\né–‹å§‹æ—¥æœŸè¨­å®šç‚ºï¼š${formatDateWithDay(nextStartDate)}\næ‚¨ç¾åœ¨å¯ä»¥ç´€éŒ„é€™æ”¯æ–°ç­†çš„æ–½æ‰“äº†ã€‚`);
            };

            const handleEdit = (record) => {
                setFormDate(record.date);
                setFormWeight(record.weight || '');
                setFormNote(record.note || '');
                if (record.dosage > 0) {
                    setRecordType('injection');
                    setFormDosage(record.dosage);
                    setFormSite(record.site);
                    setFormSymptoms(record.symptoms || []);
                    setFormClicks(mgToClicks(record.dosage).toString());
                } else {
                    setRecordType('weight');
                    setFormSymptoms([]);
                }
                setEditingId(record.id);
                setActiveTab('add');
            };

            const handleDelete = (id) => {
                if (window.confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) setRecords(prev => prev.filter(r => r.id !== id));
            };

            const handleResetPen = () => {
                const today = new Date().toISOString().split('T')[0];
                if (window.confirm(`ç¢ºå®šè¦å•Ÿç”¨æ–°ç­†ï¼ˆç¬¬ ${userProfile.penCount + 1} æ”¯ï¼‰å—ï¼Ÿ\n\nãƒ»èˆŠç­†çš„æ–½æ‰“ç´€éŒ„æœƒä¿ç•™\nãƒ»è¨ˆç®—å‰©é¤˜é‡å°‡å¾ä»Šå¤©é‡æ–°é–‹å§‹\nãƒ»ç­†çš„ç·¨è™Ÿæœƒè‡ªå‹• +1`)) {
                    setUserProfile(prev => ({ 
                        ...prev, 
                        currentPenStartDate: today,
                        penCount: (prev.penCount || 1) + 1 
                    }));
                    alert('å·²å•Ÿç”¨æ–°ç­†ï¼');
                }
            };
            
            const handleClearAll = () => {
                if (window.confirm('æ³¨æ„ï¼ç¢ºèªè¦æ¸…é™¤æ‰€æœ‰æ–½æ‰“åŠé«”é‡ç´€éŒ„ï¼Ÿ\n\n(æ¸…é™¤å¾Œå°‡ç„¡æ³•å¾©åŸï¼Œä¸¦æœƒå›åˆ°åˆå§‹è¨­å®šç•«é¢)')) {
                    localStorage.removeItem('saxenda_records');
                    localStorage.removeItem('saxenda_profile');
                    setRecords([]);
                    setUserProfile({
                        height: '',
                        targetWeight: '',
                        penTotal: 4.0,
                        currentPenStartDate: new Date().toISOString().split('T')[0],
                        penCount: 1,
                        isInitialized: false
                    });
                }
            };

            const toggleSymptom = (sym) => {
                if (formSymptoms.includes(sym)) setFormSymptoms(prev => prev.filter(s => s !== sym));
                else {
                    if (sym === 'ç„¡å‰¯ä½œç”¨') setFormSymptoms(['ç„¡å‰¯ä½œç”¨']);
                    else setFormSymptoms(prev => [...prev.filter(s => s !== 'ç„¡å‰¯ä½œç”¨'), sym]);
                }
            };

            // --- Components ---
            const SyringeGauge = ({ percentage, remaining, remainingClicks }) => {
                const barrelWidth = 140; const barrelStart = 50;
                const liquidWidth = (percentage / 100) * barrelWidth;
                
                const liquidX = barrelStart; 
                const plungerHeadX = barrelStart + liquidWidth;

                return (
                    <div className="w-full py-4 flex items-center justify-center">
                        <svg width="100%" height="80" viewBox="0 0 280 80" className="drop-shadow-sm overflow-visible">
                            <defs>
                                <linearGradient id="liquidGradient" x1="0" x2="1" y1="0" y2="0">
                                    <stop offset="0%" stopColor="#68C5DB" />
                                    <stop offset="100%" stopColor="#448FA3" />
                                </linearGradient>
                            </defs>
                            <text x={barrelStart + barrelWidth / 2} y="12" fontSize="14" fontWeight="bold" fill="#448FA3" textAnchor="middle">
                                å‰©é¤˜ {Math.round(percentage)}%
                            </text>
                            <g transform="translate(0, 15)">
                                <rect x={barrelStart - 10} y="22" width="10" height="16" fill="#cbd5e1" /> 
                                <rect x={barrelStart - 30} y="28" width="20" height="4" fill="#94a3b8" /> 
                                <g className="transition-all duration-1000 ease-out" style={{ transform: `translateX(${plungerHeadX}px)` }}>
                                    <path d="M 0 22 L 5 22 L 5 38 L 0 38 Q -2 30 0 22" fill="#475569" />
                                    <rect x="5" y="27" width="50" height="6" fill="#cbd5e1" rx="2" />
                                    <rect x="50" y="20" width="8" height="20" fill="#94a3b8" rx="2" />
                                </g>
                                <rect x={barrelStart} y="15" width={barrelWidth} height="30" rx="4" fill="rgba(255,255,255,0.3)" stroke="#448FA3" strokeWidth="2" />
                                <rect x={barrelStart} y="17" width={Math.max(0, liquidWidth - 2)} height="26" rx="1" fill="url(#liquidGradient)" className="transition-all duration-1000 ease-out" opacity={percentage > 0 ? 1 : 0} />
                                {[0.2, 0.4, 0.6, 0.8].map((p, i) => (<line key={i} x1={barrelStart + (barrelWidth * p)} y1="15" x2={barrelStart + (barrelWidth * p)} y2="22" stroke="#448FA3" strokeWidth="1" />))}
                                {[0.2, 0.4, 0.6, 0.8].map((p, i) => (<line key={`b-${i}`} x1={barrelStart + (barrelWidth * p)} y1="38" x2={barrelStart + (barrelWidth * p)} y2="45" stroke="#448FA3" strokeWidth="1" />))}
                                <text x={barrelStart + barrelWidth / 2} y="58" fontSize="10" fill="#448FA3" textAnchor="middle">{remaining} mg ({remainingClicks}æ ¼)</text>
                            </g>
                        </svg>
                    </div>
                );
            };

            const SimpleLineChart = ({ data }) => {
                const validData = data.filter(r => r.weight !== null && r.weight !== '' && !isNaN(r.weight));
                if (!validData || validData.length < 2) return (
                    <div className="h-48 flex items-center justify-center text-slate-400 bg-white/50 rounded-lg border border-dashed border-primary-200"><p className="text-sm text-primary-600">è¼¸å…¥å…©ç­†ä»¥ä¸Šé«”é‡å¾Œé¡¯ç¤ºè¶¨å‹¢åœ–</p></div>
                );
                const chartData = [...validData].sort((a, b) => new Date(a.date) - new Date(b.date)).map(r => ({ date: r.date, val: r.weight }));
                const weights = chartData.map(d => d.val);
                const min = Math.min(...weights) - 1; const max = Math.max(...weights) + 1;
                const range = max - min; const w = 100; const h = 50;
                const points = chartData.map((d, i) => {
                    const x = (i / (chartData.length - 1)) * w;
                    const y = h - ((d.val - min) / range) * h;
                    return `${x},${y}`;
                }).join(' ');
                
                return (
                    <div className="w-full h-48 mt-4">
                        <svg viewBox={`0 0 ${w} ${h}`} className="w-full h-full overflow-visible">
                            {[0, 0.25, 0.5, 0.75, 1].map(p => (<line key={p} x1="0" y1={p * h} x2={w} y2={p * h} stroke="#c2e7f0" strokeWidth="0.2" />))}
                            <polyline fill="none" stroke="#448FA3" strokeWidth="1" points={points} strokeLinecap="round" strokeLinejoin="round" />
                            {chartData.map((d, i) => {
                                const x = (i / (chartData.length - 1)) * w;
                                const y = h - ((d.val - min) / range) * h;
                                return (
                                    <g key={i} className="group">
                                        <circle cx={x} cy={y} r="1.5" fill="white" stroke="#448FA3" strokeWidth="0.5" />
                                    </g>
                                );
                            })}
                        </svg>
                        <div className="flex justify-between text-xs text-primary-600 mt-2 font-medium">
                            <span>{formatDateWithDay(chartData[0].date).slice(5)}</span>
                            <span>{formatDateWithDay(chartData[chartData.length - 1].date).slice(5)}</span>
                        </div>
                    </div>
                );
            };

            // --- Render Logic ---

            if (activeTab === 'onboarding') {
                return (
                    <div className="min-h-screen bg-primary-50 font-sans text-slate-800 flex items-center justify-center p-4 safe-area-inset-bottom">
                        <Card className="w-full max-w-md p-6 shadow-xl bg-white/90 backdrop-blur-sm">
                            <div className="text-center mb-6">
                                <div className="bg-primary-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3 shadow-sm">
                                    <AppLogo size={40} color="#448FA3" />
                                </div>
                                <h1 className="text-2xl font-bold text-slate-800">æ­¡è¿ä½¿ç”¨ Wegovy ç´€éŒ„</h1>
                                <p className="text-slate-500 mt-1">åˆæ¬¡ä½¿ç”¨è«‹è¨­å®šæ‚¨çš„åŸºæœ¬è³‡æ–™</p>
                            </div>
                            
                            <form onSubmit={handleCompleteSetup} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 mb-1 flex items-center gap-2"><User size={16} className="text-primary-600"/>èº«é«˜ (cm)</label>
                                    <input 
                                        type="number" 
                                        required
                                        placeholder="ä¾‹å¦‚: 170"
                                        value={setupHeight} 
                                        onChange={(e) => setSetupHeight(e.target.value)} 
                                        className="w-full p-3 border border-primary-100 rounded-xl focus:ring-2 focus:ring-primary-500 focus:outline-none bg-white" 
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 mb-1 flex items-center gap-2"><Target size={16} className="text-primary-600"/>ç›®æ¨™é«”é‡ (kg)</label>
                                    <input 
                                        type="number" 
                                        required
                                        placeholder="ä¾‹å¦‚: 60"
                                        value={setupTarget} 
                                        onChange={(e) => setSetupTarget(e.target.value)} 
                                        className="w-full p-3 border border-primary-100 rounded-xl focus:ring-2 focus:ring-primary-500 focus:outline-none bg-white" 
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 mb-1 flex items-center gap-2"><Syringe size={16} className="text-primary-600"/>è—¥ç­†ç¸½å®¹é‡ (mg)</label>
                                    <input 
                                        type="number" 
                                        step="0.1"
                                        required
                                        value={setupPenTotal} 
                                        onChange={(e) => setSetupPenTotal(e.target.value)} 
                                        className="w-full p-3 border border-primary-100 rounded-xl focus:ring-2 focus:ring-primary-500 focus:outline-none bg-white" 
                                    />
                                    <p className="text-xs text-slate-400 mt-1 pl-1">é è¨­ 4.0mg (0.25mg å¯æ‰“ 16 æ¬¡)</p>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 mb-1 flex items-center gap-2"><Calendar size={16} className="text-primary-600"/>ç›®å‰è—¥ç­†é–‹å§‹æ—¥æœŸ</label>
                                    <input 
                                        type="date" 
                                        required
                                        value={setupStartDate} 
                                        onChange={(e) => setSetupStartDate(e.target.value)} 
                                        className="w-full p-3 border border-primary-100 rounded-xl focus:ring-2 focus:ring-primary-500 focus:outline-none bg-white" 
                                    />
                                    <p className="text-xs text-slate-400 mt-1 pl-1">ç”±æ­¤æ—¥æœŸå¾Œçš„æ–½æ‰“ç´€éŒ„å°‡è¨ˆå…¥æœ¬æ”¯è—¥ç­†æ¶ˆè€—</p>
                                </div>
                                
                                <button 
                                    type="submit" 
                                    className="w-full bg-primary-500 text-white py-3.5 rounded-xl font-bold shadow-lg hover:shadow-xl transition mt-6 flex items-center justify-center gap-2 active:scale-95 transform"
                                >
                                    é–‹å§‹ä½¿ç”¨ <ChevronRight size={20} />
                                </button>
                            </form>
                            
                            <div className="mt-6 bg-orange-50 border border-orange-100 rounded-xl p-3 flex gap-2 text-xs text-orange-700 items-start">
                                <AlertCircle size={16} className="shrink-0 mt-0.5" />
                                <p>ç´€éŒ„åªæœƒå„²å­˜åœ¨ä½ çš„è£ç½®ï¼Œä¸æœƒä¸Šå‚³åˆ°å…¶ä»–ç©ºé–“ï¼›å¦‚æœåˆªé™¤APPæˆ–æ›è£ç½®ç™»å…¥å°±æœƒæ¶ˆå¤±ã€‚</p>
                            </div>
                        </Card>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-primary-50 font-sans text-slate-800 pb-24 safe-area-inset-bottom">
                    <header className="bg-primary-500 text-white p-4 shadow-md sticky top-0 z-20 pt-safe">
                        <div className="max-w-md mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <AppLogo size={28} />
                                <h1 className="text-xl font-bold tracking-wide text-white drop-shadow-sm">Wegovy ç´€éŒ„</h1>
                            </div>
                            <button onClick={() => setActiveTab('settings')} className="text-primary-50 hover:text-white text-sm font-medium transition">è¨­å®š</button>
                        </div>
                    </header>

                    <main className="max-w-md mx-auto p-4 space-y-4">
                        {showNotification && (
                            <div className="fixed top-20 left-1/2 transform -translate-x-1/2 bg-slate-800/90 backdrop-blur text-white px-6 py-2.5 rounded-full shadow-xl z-50 animate-bounce flex items-center gap-2 font-medium">
                                <Save size={18} className="text-primary-400"/> ç´€éŒ„å·²å„²å­˜ï¼
                            </div>
                        )}

                        {activeTab === 'dashboard' && (
                            <div className="space-y-4">
                                {stats.lastDose > 0 && stats.dosesLeft <= 2 && (
                                    <div className="bg-orange-50 border border-orange-200 rounded-xl p-4 flex items-start gap-3 animate-pulse shadow-sm">
                                        <AlertCircle className="text-orange-500 shrink-0 mt-0.5" size={20} />
                                        <div>
                                            <h3 className="font-bold text-orange-700 text-sm">è—¥é‡åº«å­˜é è­¦</h3>
                                            <p className="text-xs text-orange-600 mt-1">
                                                ç›®å‰é ä¼°å‰©é¤˜åŠ‘é‡åƒ…å‰© {stats.dosesLeft} æ¬¡ï¼ˆç´„ {stats.dosesLeft} é€±ï¼‰ã€‚<br/>
                                                å»ºè­°æ‚¨ç›¡å¿«å®‰æ’å›è¨ºæˆ–è³¼è²·æ–°çš„è—¥ç­†ï¼Œä»¥å…ä¸­æ–·ç™‚ç¨‹ã€‚
                                            </p>
                                        </div>
                                    </div>
                                )}

                                <Card className="p-4 bg-white border-primary-100 shadow-sm">
                                    <div className="flex justify-between items-center mb-1">
                                        <h3 className="font-bold text-slate-700 flex items-center gap-2"><Syringe className="text-primary-600" size={20} />è—¥ç‰©ç›£æ§</h3>
                                        <div className="flex flex-col items-end">
                                            <span className="text-xs text-slate-400 font-bold mb-0.5 bg-slate-100 px-2 py-0.5 rounded-full">ç¬¬ {userProfile.penCount} æ”¯</span>
                                            <div className="mt-1">
                                                <span className="text-sm font-bold text-primary-700">ç´„ {stats.dosesLeft} æ¬¡</span>
                                                <span className="text-[10px] text-slate-400 ml-1">(ä»¥ {stats.calculationBaseDose}mg æ¨ç®—)</span>
                                            </div>
                                        </div>
                                    </div>
                                    <SyringeGauge percentage={stats.progressPercent} remaining={stats.remaining} remainingClicks={stats.remainingClicks} />
                                    <div className="grid grid-cols-2 gap-4 mt-2 pt-2 border-t border-slate-50">
                                        <div>
                                            <span className="block text-[10px] uppercase tracking-wider mb-0.5 text-slate-400 font-bold">LAST DOSE</span>
                                            <div className="flex items-baseline gap-1">
                                                <span className="font-bold text-slate-700 text-sm">{stats.lastDose} mg</span>
                                                <span className="text-[10px] text-primary-600 font-medium">({mgToClicks(stats.lastDose)}æ ¼)</span>
                                            </div>
                                            <span className="text-[10px] text-slate-400 block mt-0.5">{stats.lastInjectionDate ? formatDateWithDay(stats.lastInjectionDate) : ''}</span>
                                        </div>
                                        <div className="text-right">
                                            <span className="block text-[10px] uppercase tracking-wider mb-0.5 text-slate-400 font-bold">NEXT DOSE</span>
                                            {stats.nextInjectionDate ? (
                                                <div>
                                                    <div className={`font-bold text-sm ${stats.daysUntilNext <= 1 ? 'text-orange-500' : 'text-slate-700'}`}>
                                                        {stats.daysUntilNext <= 0 ? 'ä»Šå¤©!' : `${stats.daysUntilNext} å¤©å¾Œ`}
                                                    </div>
                                                    <div className="text-[10px] text-slate-400">{formatDateWithDay(stats.nextInjectionDate)}</div>
                                                </div>
                                            ) : <span className="text-xs text-slate-300">--</span>}
                                        </div>
                                    </div>
                                </Card>

                                <Card className="p-5 bg-gradient-to-br from-primary-500 to-primary-700 text-white border-none shadow-lg shadow-primary-200">
                                    <div className="flex justify-between items-start mb-4">
                                        <div>
                                            <p className="text-primary-50 text-xs font-bold mb-1 flex items-center gap-1"><Scale size={12}/> ç›®å‰é«”é‡</p>
                                            <div className="flex items-baseline gap-2">
                                                <span className="text-4xl font-bold tracking-tight text-white drop-shadow-sm">{stats.current > 0 ? stats.current : '--'}</span>
                                                <span className="text-lg opacity-90">kg</span>
                                            </div>
                                        </div>
                                        <div className="text-right bg-white/20 px-3 py-2 rounded-xl backdrop-blur-sm border border-white/10">
                                            <p className="text-primary-50 text-[10px] mb-0.5 font-medium">BMI</p>
                                            <span className="text-xl font-bold">{stats.bmi > 0 ? stats.bmi : '--'}</span>
                                        </div>
                                    </div>
                                    <div className="flex gap-3 mb-4">
                                        <div className="flex items-center gap-1.5 bg-black/10 px-2.5 py-1.5 rounded-lg text-xs font-medium"><TrendingDown size={14} className="text-white" /><span>å·²æ¸› {stats.loss} kg</span></div>
                                        <div className="flex items-center gap-1.5 bg-black/10 px-2.5 py-1.5 rounded-lg text-xs font-medium"><Target size={14} className="text-white" /><span>ç›®æ¨™ {userProfile.targetWeight} kg</span></div>
                                    </div>
                                    <div>
                                        <div className="flex justify-between text-[10px] text-primary-50 mb-1.5 font-medium px-0.5">
                                            <span>èµ·å§‹: {stats.start} kg</span>
                                            <span>å‰©é¤˜: {(stats.current - userProfile.targetWeight).toFixed(1)} kg</span>
                                        </div>
                                        <div className="w-full bg-black/20 rounded-full h-2.5 overflow-hidden">
                                            <div className="bg-white h-2.5 rounded-full transition-all duration-1000 ease-out shadow-[0_0_15px_rgba(255,255,255,0.6)]" style={{ width: `${stats.current > 0 ? Math.min(100, Math.max(0, ((stats.start - stats.current) / (stats.start - userProfile.targetWeight)) * 100)) : 0}%` }}></div>
                                        </div>
                                    </div>
                                </Card>

                                <Card className="p-4 bg-white border-primary-100 shadow-sm">
                                    <h3 className="font-bold text-slate-700 mb-2 flex items-center gap-2"><TrendingDown size={18} className="text-primary-600"/>é«”é‡è¶¨å‹¢</h3>
                                    <SimpleLineChart data={records} />
                                </Card>
                            </div>
                        )}

                        {activeTab === 'add' && (
                            <div className="animate-fade-in space-y-4 pb-24"> 
                                <Card className="p-5 border-primary-100 shadow-sm bg-white">
                                    <h2 className="text-lg font-bold text-slate-800 mb-5 flex items-center gap-2 border-b border-slate-100 pb-3">
                                        {editingId ? <Edit2 className="text-primary-600" /> : <Plus className="text-primary-600" />} 
                                        {editingId ? 'ç·¨è¼¯ç´€éŒ„' : 'æ–°å¢ç´€éŒ„'}
                                    </h2>
                                    
                                    <div className="flex p-1 bg-slate-100 rounded-xl mb-6">
                                        <button type="button" onClick={() => setRecordType('weight')} className={`flex-1 py-2.5 text-sm font-bold rounded-lg transition-all flex items-center justify-center gap-2 ${recordType === 'weight' ? 'bg-white text-primary-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}><Scale size={18} /> é«”é‡ç´€éŒ„</button>
                                        <button type="button" onClick={() => setRecordType('injection')} className={`flex-1 py-2.5 text-sm font-bold rounded-lg transition-all flex items-center justify-center gap-2 ${recordType === 'injection' ? 'bg-white text-primary-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}><Syringe size={18} /> æ‰“é‡ç´€éŒ„</button>
                                    </div>

                                    <form onSubmit={handleAddRecord} className="space-y-5">
                                        <div>
                                            <label className="block text-sm font-bold text-slate-700 mb-1.5 flex items-center gap-2"><Calendar size={16} className="text-primary-600" />æ—¥æœŸ</label>
                                            <div className="relative">
                                                <input type="date" required value={formDate} onChange={(e) => setFormDate(e.target.value)} className="w-full pl-3 pr-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 bg-slate-50 focus:bg-white text-slate-700 font-medium" />
                                            </div>
                                            <p className="text-xs text-slate-400 mt-1 pl-1">{formatDateWithDay(formDate)}</p>
                                        </div>
                                        
                                        {recordType === 'weight' && (
                                            <div className="animate-fade-in">
                                                <label className="block text-sm font-bold text-slate-700 mb-1.5 flex items-center gap-2"><Scale size={16} className="text-primary-600" />é«”é‡ (kg)</label>
                                                <div className="relative">
                                                    <input type="number" step="0.1" required placeholder="è«‹è¼¸å…¥é«”é‡" value={formWeight} onChange={(e) => setFormWeight(e.target.value)} className="w-full pl-3 pr-2 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 bg-slate-50 focus:bg-white text-lg font-bold text-slate-700" />
                                                </div>
                                            </div>
                                        )}

                                        {recordType === 'injection' && (
                                            <div className="animate-fade-in space-y-5">
                                                <div>
                                                    <div className="flex justify-between items-center mb-1.5">
                                                        <label className="block text-sm font-bold text-slate-700 flex items-center gap-2"><Syringe size={16} className="text-primary-600" />æ–½æ‰“åŠ‘é‡</label>
                                                        <div className="flex bg-slate-100 rounded-lg p-0.5">
                                                            <button 
                                                                type="button"
                                                                onClick={() => setDosageUnit('mg')} 
                                                                className={`px-3 py-1 text-xs rounded-md transition font-bold ${dosageUnit === 'mg' ? 'bg-white shadow text-primary-600' : 'text-slate-400'}`}
                                                            >
                                                                mg
                                                            </button>
                                                            <button 
                                                                type="button"
                                                                onClick={() => setDosageUnit('clicks')} 
                                                                className={`px-3 py-1 text-xs rounded-md transition font-bold ${dosageUnit === 'clicks' ? 'bg-white shadow text-primary-600' : 'text-slate-400'}`}
                                                            >
                                                                æ ¼æ•¸
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="flex gap-2 mb-3">
                                                        <div className="relative flex-1">
                                                            {dosageUnit === 'mg' ? (
                                                                <input 
                                                                    type="number" 
                                                                    step="0.01" 
                                                                    required 
                                                                    value={formDosage} 
                                                                    onChange={(e) => setFormDosage(e.target.value)} 
                                                                    className="w-full pl-3 pr-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 font-bold text-teal-700 text-lg bg-slate-50 focus:bg-white" 
                                                                />
                                                            ) : (
                                                                <input 
                                                                    type="number" 
                                                                    step="1" 
                                                                    required 
                                                                    value={formClicks} 
                                                                    onChange={(e) => setFormClicks(e.target.value)} 
                                                                    className="w-full pl-3 pr-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 font-bold text-teal-700 text-lg bg-slate-50 focus:bg-white" 
                                                                />
                                                            )}
                                                        </div>
                                                        <div className="flex flex-col items-center justify-center bg-primary-50 border border-primary-100 text-primary-700 rounded-xl px-4 min-w-[90px]">
                                                            {dosageUnit === 'mg' ? (
                                                                <>
                                                                    <span className="font-bold text-xl">{mgToClicks(formDosage)}</span>
                                                                    <span className="text-[10px] font-bold opacity-70">æ ¼</span>
                                                                </>
                                                            ) : (
                                                                <>
                                                                    <span className="font-bold text-xl">{clicksToMg(formClicks)}</span>
                                                                    <span className="text-[10px] font-bold opacity-70">mg</span>
                                                                </>
                                                            )}
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="flex justify-between items-center mb-1 text-xs text-slate-400">
                                                        <span>å¿«é€Ÿé¸æ“‡:</span>
                                                        <span className="text-primary-500 font-medium">åº«å­˜: {stats.remaining} mg ({stats.remainingClicks}æ ¼)</span>
                                                    </div>
                                                    <div className="grid grid-cols-6 gap-1.5">
                                                        {DOSAGE_SUGGESTIONS.map((opt) => {
                                                            const isOverLimit = opt.value > parseFloat(stats.remaining) + 0.01;
                                                            return (
                                                                <button 
                                                                    type="button" 
                                                                    key={opt.value} 
                                                                    onClick={() => {
                                                                        if (!isOverLimit) {
                                                                            setFormDosage(opt.value.toString());
                                                                            setFormClicks(mgToClicks(opt.value).toString());
                                                                        }
                                                                    }} 
                                                                    disabled={isOverLimit}
                                                                    className={`py-1.5 px-0.5 text-xs rounded-lg border transition flex flex-col items-center justify-center h-11 
                                                                        ${parseFloat(formDosage) === opt.value ? 'bg-primary-50 border-primary-500 text-primary-700 font-bold ring-1 ring-primary-500' : 
                                                                        isOverLimit ? 'bg-slate-50 text-slate-300 border-slate-100 cursor-not-allowed opacity-60' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}
                                                                >
                                                                    <span className="text-[11px]">{opt.value}</span>
                                                                    <span className="text-[8px] opacity-60 scale-90">{mgToClicks(opt.value)}æ ¼</span>
                                                                </button>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold text-slate-700 mb-1.5 flex items-center gap-2"><Target size={16} className="text-primary-600" />æ–½æ‰“éƒ¨ä½</label>
                                                    <div className="flex gap-2">
                                                        {['è…¹éƒ¨', 'å¤§è…¿', 'æ‰‹è‡‚'].map(site => (
                                                            <button type="button" key={site} onClick={() => setFormSite(site)} className={`flex-1 py-2.5 text-sm rounded-xl border transition font-medium ${formSite === site ? 'bg-primary-50 border-primary-500 text-primary-700 ring-1 ring-primary-500' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}>{site}</button>
                                                        ))}
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold text-slate-700 mb-1.5 flex items-center gap-2"><Stethoscope size={16} className="text-primary-600" />èº«é«”åæ‡‰</label>
                                                    <div className="flex flex-wrap gap-2">
                                                        {COMMON_SYMPTOMS.map(sym => (
                                                            <button key={sym} type="button" onClick={() => toggleSymptom(sym)} className={`px-3 py-1.5 text-xs rounded-full border transition font-bold flex items-center gap-1 ${formSymptoms.includes(sym) ? 'bg-orange-50 border-orange-400 text-orange-700' : 'bg-white border-slate-200 text-slate-500 hover:bg-slate-50'}`}>
                                                                {/* ç°¡å–®æ ¹æ“šç—‡ç‹€åŠ å€‹å°åœ–ç¤º */}
                                                                {sym}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                        {/* Note field removed from UI */}
                                    </form>
                                </Card>
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div className="space-y-3 animate-fade-in pb-20">
                                <div className="flex justify-between items-center mb-1 px-1"><h3 className="font-bold text-slate-700 text-lg">æ­·å²ç´€éŒ„</h3><span className="text-xs text-slate-400 font-medium bg-slate-100 px-2 py-1 rounded-full">{displayedHistory.length} ç­†</span></div>
                                <div className="flex p-1 bg-slate-100 rounded-xl mb-4">
                                    <button onClick={() => setHistoryType('injection')} className={`flex-1 py-2.5 text-sm font-bold rounded-lg transition-all flex items-center justify-center gap-2 ${historyType === 'injection' ? 'bg-white text-primary-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}><Syringe size={16} /> æ–½æ‰“ç´€éŒ„</button>
                                    <button onClick={() => setHistoryType('weight')} className={`flex-1 py-2.5 text-sm font-bold rounded-lg transition-all flex items-center justify-center gap-2 ${historyType === 'weight' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}><Scale size={16} /> é«”é‡ç´€éŒ„</button>
                                </div>
                                {displayedHistory.length === 0 ? (
                                    <div className="text-center py-16 text-slate-400 flex flex-col items-center"><div className="bg-slate-100 p-4 rounded-full mb-3"><History size={32} className="opacity-30" /></div><p className="font-medium">ç›®å‰æ²’æœ‰{historyType === 'injection' ? 'æ–½æ‰“' : 'é«”é‡'}ç´€éŒ„</p></div>
                                ) : (
                                    displayedHistory.map((record) => (
                                        <Card key={record.id} className="p-3 flex flex-row items-center justify-between hover:bg-slate-50 transition group border-l-4 border-l-transparent hover:border-l-primary-400">
                                            {/* å·¦å´ï¼šæ—¥æœŸèˆ‡ä¸»è¦æ•¸æ“š */}
                                            <div className="flex flex-col gap-1 flex-1" onClick={() => handleEdit(record)}>
                                                <div className="flex items-baseline gap-2">
                                                    <span className="font-bold text-slate-800 text-base">{formatDateWithDay(record.date)}</span>
                                                    {historyType === 'injection' && record.penCount && (
                                                        <span className="text-[9px] text-slate-400 border border-slate-200 px-1.5 py-0.5 rounded bg-slate-50"># {record.penCount}</span>
                                                    )}
                                                </div>
                                                
                                                <div className="flex items-center gap-2">
                                                    {historyType === 'weight' ? 
                                                        <span className="text-blue-600 font-bold flex items-center gap-1.5 text-lg"><Scale size={16} /> {record.weight} <span className="text-xs font-normal text-slate-500">kg</span></span> 
                                                        : 
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-primary-600 font-bold flex items-center gap-1.5 text-lg"><Syringe size={16} /> {record.dosage} <span className="text-xs font-normal text-slate-500">mg</span></span>
                                                            <span className="text-xs text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded">({mgToClicks(record.dosage)}æ ¼)</span>
                                                        </div>
                                                    }
                                                </div>
                                                
                                                {/* æ–½æ‰“éƒ¨ä½æˆ–å‚™è¨» */}
                                                <div className="flex flex-wrap gap-2 mt-0.5">
                                                     {(historyType === 'injection' || record.dosage > 0) && <span className="text-xs text-slate-500 flex items-center gap-1"><Target size={10}/> {record.site}</span>}
                                                     {record.note && <span className="text-xs text-slate-400 flex items-center gap-1 max-w-[150px] truncate"><FileText size={10}/> {record.note}</span>}
                                                </div>
                                                
                                                {/* å‰¯ä½œç”¨æ¨™ç±¤ */}
                                                {historyType === 'injection' && record.symptoms && record.symptoms.length > 0 && (
                                                    <div className="flex flex-wrap gap-1 mt-1">
                                                        {record.symptoms.map(s => (<span key={s} className="text-[9px] bg-orange-50 text-orange-600 px-1.5 py-0.5 rounded border border-orange-100">{s}</span>))}
                                                    </div>
                                                )}
                                            </div>

                                            {/* å³å´ï¼šæ“ä½œæŒ‰éˆ• */}
                                            <div className="flex flex-col gap-2 pl-2 border-l border-slate-100 ml-2">
                                                <button onClick={() => handleEdit(record)} className="p-2 text-slate-300 hover:text-primary-600 hover:bg-primary-50 rounded-lg transition"><Edit2 size={16} /></button>
                                                <button onClick={() => handleDelete(record.id)} className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition"><Trash2 size={16} /></button>
                                            </div>
                                        </Card>
                                    ))
                                )}
                            </div>
                        )}

                        {activeTab === 'settings' && (
                            <div className="animate-fade-in pb-20">
                                <Card className="p-5 border-primary-100 shadow-md">
                                    <h2 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2"><User className="text-primary-600"/>å€‹äººè¨­å®š</h2>
                                    <div className="space-y-6">
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">èº«é«˜ (cm)</label>
                                                <input type="number" value={userProfile.height} onChange={(e) => setUserProfile({...userProfile, height: parseFloat(e.target.value)})} className="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:outline-none bg-slate-50 font-bold text-slate-700" />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">ç›®æ¨™é«”é‡ (kg)</label>
                                                <input type="number" value={userProfile.targetWeight} onChange={(e) => setUserProfile({...userProfile, targetWeight: parseFloat(e.target.value)})} className="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:outline-none bg-slate-50 font-bold text-slate-700" />
                                            </div>
                                        </div>
                                        
                                        <div className="pt-6 border-t border-slate-100">
                                            <h3 className="text-sm font-bold text-slate-800 mb-4 flex items-center gap-2"><Syringe className="text-primary-600" size={18}/> è—¥ç­†è¨­å®š</h3>
                                            <div className="space-y-4">
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">è—¥ç­†ç¸½å®¹é‡ (mg)</label>
                                                    <input type="number" step="0.1" value={userProfile.penTotal} onChange={(e) => setUserProfile({...userProfile, penTotal: parseFloat(e.target.value)})} className="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:outline-none bg-slate-50 font-bold text-slate-700" />
                                                    <p className="text-xs text-slate-400 mt-1.5 flex items-center gap-1"><AlertCircle size={12}/> é è¨­ 4.0mg (0.25mg x 16æ¬¡) = 300æ ¼</p>
                                                </div>
                                                <button onClick={handleResetPen} className="flex items-center justify-center gap-2 w-full text-primary-600 text-sm border border-primary-200 px-4 py-3 rounded-xl hover:bg-primary-50 font-bold transition"><RefreshCw size={16} /> å•Ÿç”¨æ–°çš„ä¸€æ”¯ç­† (é‡ç½®è¨ˆæ•¸)</button>
                                            </div>
                                        </div>
                                        
                                        <div className="pt-6 border-t border-slate-100">
                                            <h3 className="text-sm font-bold text-slate-800 mb-4 flex items-center gap-2"><Trash2 className="text-red-400" size={18}/> è³‡æ–™ç®¡ç†</h3>
                                            <button onClick={handleClearAll} className="text-red-500 text-sm border border-red-200 px-4 py-3 rounded-xl hover:bg-red-50 w-full font-bold transition flex items-center justify-center gap-2"><Trash2 size={16}/> æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>
                                        </div>
                                    </div>
                                    <div className="mt-8 flex justify-end"><button onClick={() => setActiveTab('dashboard')} className="bg-gradient-to-r from-primary-500 to-primary-600 text-white px-8 py-3 rounded-xl font-bold shadow-md hover:shadow-lg transition">å®Œæˆ</button></div>
                                </Card>
                            </div>
                        )}
                    </main>

                    {/* å„²å­˜æŒ‰éˆ• - æ‡¸æµ®æ–¼åº•éƒ¨ (Sticky) */}
                    {activeTab === 'add' && (
                        <div className="fixed bottom-24 left-0 right-0 p-4 z-30 bg-gradient-to-t from-slate-50 via-slate-50 to-transparent pb-safe">
                            <div className="flex gap-3 max-w-md mx-auto">
                                {editingId && (
                                    <button 
                                        type="button" 
                                        onClick={() => { setEditingId(null); setActiveTab('history'); }} 
                                        className="flex-1 bg-white border border-slate-300 text-slate-600 py-3.5 rounded-xl font-bold shadow-sm hover:bg-slate-50 transition"
                                    >
                                        å–æ¶ˆ
                                    </button>
                                )}
                                <button 
                                    type="button"
                                    onClick={handleAddRecord}
                                    className="flex-1 bg-gradient-to-r from-primary-500 to-primary-600 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-primary-200 hover:shadow-xl hover:translate-y-[-1px] transition flex items-center justify-center gap-2 active:scale-95"
                                >
                                    <Save size={20} />
                                    {editingId ? 'æ›´æ–°ç´€éŒ„' : 'å„²å­˜ç´€éŒ„'}
                                </button>
                            </div>
                        </div>
                    )}
                    
                    {/* åŠ‘é‡ä¸è¶³è­¦å‘Šè¦–çª— */}
                    {showInsufficientModal && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-fade-in-up border border-orange-100">
                                <div className="flex items-center gap-3 text-orange-600 mb-4">
                                    <div className="bg-orange-100 p-2 rounded-full"><AlertCircle size={28} /></div>
                                    <h3 className="text-xl font-bold text-slate-800">å‰©é¤˜åŠ‘é‡ä¸è¶³</h3>
                                </div>
                                <p className="text-slate-600 mb-6 text-sm leading-relaxed">
                                    ç›®å‰è—¥ç­†åº«å­˜åƒ…å‰© <span className="text-primary-600 font-bold text-base">{stats.remaining} mg</span>ï¼Œ<br/>ä½†æ‚¨è¼¸å…¥äº† <b>{formDosage} mg</b>ã€‚
                                </p>
                                <div className="flex flex-col gap-3">
                                    <button 
                                        onClick={saveRecord} // ç›´æ¥å„²å­˜ï¼Œå³å¼·åˆ¶è¨˜éŒ„
                                        className="w-full bg-orange-500 text-white py-3.5 rounded-xl font-bold hover:bg-orange-600 transition shadow-lg shadow-orange-100"
                                    >
                                        ä»è¦ç´€éŒ„ (æº¢å……)
                                    </button>
                                    <button 
                                        onClick={handleUseRemaining}
                                        className="w-full bg-primary-50 text-primary-700 py-3.5 rounded-xl font-bold hover:bg-primary-100 transition"
                                    >
                                        ä¾å‰©é¤˜é‡æ–½æ‰“ ({stats.remaining} mg)
                                    </button>
                                    <button 
                                        onClick={() => setShowInsufficientModal(false)}
                                        className="w-full bg-slate-100 text-slate-600 py-3.5 rounded-xl font-bold hover:bg-slate-200 transition"
                                    >
                                        å–æ¶ˆ
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* è—¥ç­†ç”¨ç›¡æç¤ºè¦–çª— */}
                    {showNewPenModal && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-fade-in-up border border-primary-100">
                                <div className="flex items-center gap-3 text-primary-600 mb-4">
                                    <div className="bg-primary-100 p-2 rounded-full"><CheckCircle size={28} /></div>
                                    <h3 className="text-xl font-bold text-slate-800">è—¥ç­†å·²ç”¨å®Œ</h3>
                                </div>
                                <p className="text-slate-600 mb-6 text-sm leading-relaxed">
                                    é€™æ”¯ç­†çš„è—¥é‡å·²æ­¸é›¶ã€‚<br/>å»ºè­°æ‚¨æº–å‚™å•Ÿç”¨ä¸‹ä¸€æ”¯ç­†ã€‚
                                </p>
                                <div className="flex flex-col gap-3">
                                    <button 
                                        onClick={handleConfirmNewPen}
                                        className="w-full bg-gradient-to-r from-primary-500 to-primary-600 text-white py-3.5 rounded-xl font-bold hover:shadow-lg transition shadow-md"
                                    >
                                        å•Ÿç”¨ç¬¬ {userProfile.penCount + 1} æ”¯ç­†
                                    </button>
                                    <button 
                                        onClick={() => setShowNewPenModal(false)}
                                        className="w-full bg-slate-100 text-slate-600 py-3.5 rounded-xl font-bold hover:bg-slate-200 transition"
                                    >
                                        ç¨å¾Œå†èªª
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <nav className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-200 flex justify-around p-3 z-40 pb-safe w-full max-w-md mx-auto shadow-[0_-1px_10px_rgba(0,0,0,0.05)]">
                        <button onClick={() => setActiveTab('dashboard')} className={`flex flex-col items-center text-xs font-medium transition ${activeTab === 'dashboard' ? 'text-primary-600' : 'text-slate-400 hover:text-slate-600'}`}><Activity size={24} className="mb-1" />ç¸½è¦½</button>
                        <div className="relative -top-6 group">
                            <button 
                                onClick={() => { 
                                    setEditingId(null); 
                                    setFormDate(new Date().toISOString().split('T')[0]); 
                                    setFormWeight(''); 
                                    setFormNote('');
                                    setFormSymptoms([]); 
                                    setFormHeight(userProfile.height); 
                                    setRecordType('weight'); // Default to weight
                                    setActiveTab('add'); 
                                }} 
                                className={`flex flex-col items-center justify-center text-xs transition ${activeTab === 'add' ? 'text-primary-600' : 'text-slate-400 group-hover:text-slate-600'}`}
                            >
                                <div className="bg-gradient-to-br from-primary-500 to-primary-600 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg shadow-primary-200 border-4 border-white active:scale-95 transition-all transform hover:-translate-y-1 absolute top-0 pointer-events-auto">
                                    <Plus size={28} strokeWidth={3} />
                                </div>
                                <span className="mt-14 font-bold">ç´€éŒ„</span>
                            </button>
                        </div>
                        <button onClick={() => setActiveTab('history')} className={`flex flex-col items-center text-xs font-medium transition ${activeTab === 'history' ? 'text-primary-600' : 'text-slate-400 hover:text-slate-600'}`}><History size={24} className="mb-1" />æ­·ç¨‹</button>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    //]]>
    </script>
</body>
</html>
